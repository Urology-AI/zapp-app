<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ZAPP — Zapping Detection</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #18181f;
    --border: #2a2a38;
    --accent: #e8ff47;
    --accent2: #ff4747;
    --accent3: #47c4ff;
    --accent4: #47ffa0;
    --text: #e8e8f0;
    --muted: #6b6b80;
    --font-display: 'Syne', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-display);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ── Header ── */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 32px;
    border-bottom: 1px solid var(--border);
    background: rgba(10,10,15,0.9);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .status-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--muted);
    background: var(--surface2);
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
  }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); transition: background 0.3s; }
  .status-dot.ok  { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
  .status-dot.err { background: var(--accent2); box-shadow: 0 0 8px var(--accent2); }

  /* ── Layout ── */
  .app {
    display: grid;
    grid-template-columns: 1fr 400px;
    height: calc(100vh - 61px);
    overflow: hidden;
  }

  /* ── Video Panel ── */
  .video-panel {
    display: flex;
    flex-direction: column;
    padding: 24px;
    gap: 16px;
    overflow: hidden;
  }

  .drop-zone {
    flex: 1;
    border: 2px dashed var(--border);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
    overflow: hidden;
    min-height: 200px;
  }
  .drop-zone:hover, .drop-zone.dragging { border-color: var(--accent); background: rgba(232,255,71,0.03); }
  .drop-zone.has-video { border-style: solid; border-color: var(--border); }

  .drop-icon { font-size: 48px; opacity: 0.3; }
  .drop-label { font-size: 15px; color: var(--muted); font-weight: 700; }
  .drop-sub { font-size: 12px; color: var(--muted); opacity: 0.6; font-family: var(--font-mono); }

  video#player {
    width: 100%; height: 100%;
    object-fit: contain;
    display: none;
    border-radius: 8px;
    background: #000;
  }

  /* ── Timeline ── */
  .timeline-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
  }
  .timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .timeline-title { font-size: 11px; font-family: var(--font-mono); color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
  .timeline-time  { font-size: 12px; font-family: var(--font-mono); color: var(--accent); }

  .timeline-track {
    position: relative;
    height: 36px;
    background: var(--surface2);
    border-radius: 6px;
    overflow: hidden;
    cursor: pointer;
    user-select: none;
  }
  .timeline-progress  { position: absolute; left: 0; top: 0; bottom: 0; background: rgba(232,255,71,0.1); pointer-events: none; transition: width 0.05s linear; }
  .timeline-selection { position: absolute; top: 0; bottom: 0; background: rgba(71,196,255,0.2); border-left: 2px solid var(--accent3); border-right: 2px solid var(--accent3); pointer-events: none; display: none; }
  .timeline-playhead  { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--accent); box-shadow: 0 0 8px var(--accent); pointer-events: none; transform: translateX(-1px); }
  .timeline-events-overlay { position: absolute; top: 0; bottom: 0; pointer-events: none; }

  /* ── Controls ── */
  .controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family: var(--font-display);
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    text-decoration: none;
  }
  .btn:hover  { border-color: var(--accent); color: var(--accent); }
  .btn:active { transform: scale(0.97); }
  .btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .btn.primary  { background: var(--accent); color: #0a0a0f; border-color: var(--accent); }
  .btn.primary:hover { background: #d4eb30; color: #0a0a0f; }
  .btn.export   { border-color: var(--accent4); color: var(--accent4); }
  .btn.export:hover { background: rgba(71,255,160,0.08); }
  .btn.export:disabled { opacity: 0.25; }
  .btn.danger   { border-color: var(--accent2); color: var(--accent2); }
  .btn.danger:hover { background: rgba(255,71,71,0.1); }
  .btn.loading  { opacity: 0.6; cursor: wait; }

  .spacer { flex: 1; }

  /* ── Right Panel ── */
  .right-panel {
    border-left: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  .panel-section { padding: 20px; border-bottom: 1px solid var(--border); }
  .panel-section:last-child { border-bottom: none; }
  .section-label { font-size: 10px; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 14px; }

  /* ── Segment Inputs ── */
  .segment-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  .time-field  { display: flex; flex-direction: column; gap: 5px; }
  .time-field label { font-size: 10px; font-family: var(--font-mono); color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; }
  .time-input-wrap {
    display: flex;
    align-items: center;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 7px;
    overflow: hidden;
    transition: border-color 0.15s;
  }
  .time-input-wrap:focus-within { border-color: var(--accent3); }
  .time-input-wrap input {
    flex: 1; background: transparent; border: none; outline: none;
    color: var(--text); font-family: var(--font-mono); font-size: 13px;
    padding: 8px 10px; width: 0;
  }
  .time-input-wrap .unit { font-family: var(--font-mono); font-size: 10px; color: var(--muted); padding-right: 8px; }

  .set-btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
  .set-btn {
    padding: 8px; text-align: center; font-size: 11px; font-weight: 700;
    border-radius: 7px; border: 1px solid var(--border);
    background: var(--bg); color: var(--muted); cursor: pointer;
    transition: all 0.15s; font-family: var(--font-display);
  }
  .set-btn:hover { border-color: var(--accent3); color: var(--accent3); }

  .duration-bar {
    background: var(--bg); border: 1px solid var(--border); border-radius: 7px;
    padding: 10px 12px; display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 14px;
    font-family: var(--font-mono); font-size: 12px; color: var(--muted);
  }
  .duration-val { color: var(--text); font-weight: 500; }

  /* ── Inference Options ── */
  .option-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }

  /* ── Result ── */
  .result-box {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    display: none;
  }
  .result-box.visible { display: block; }

  .result-header {
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
  }
  .result-verdict { font-size: 16px; font-weight: 800; letter-spacing: -0.3px; }
  .result-verdict.zapping     { color: var(--accent2); }
  .result-verdict.non_zapping { color: var(--accent); }
  .result-confidence { font-family: var(--font-mono); font-size: 12px; color: var(--muted); }

  .prob-bars { padding: 14px 16px; display: flex; flex-direction: column; gap: 10px; }
  .prob-row  { display: flex; flex-direction: column; gap: 5px; }
  .prob-label-row { display: flex; justify-content: space-between; font-size: 11px; font-family: var(--font-mono); }
  .prob-track { height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .prob-fill { height: 100%; border-radius: 3px; transition: width 0.5s cubic-bezier(0.16,1,0.3,1); }
  .prob-fill.zapping     { background: var(--accent2); }
  .prob-fill.non_zapping { background: var(--accent); }

  .events-list  { padding: 0 16px 14px; }
  .events-title { font-size: 10px; font-family: var(--font-mono); color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
  .event-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 7px 10px;
    background: rgba(255,71,71,0.07);
    border: 1px solid rgba(255,71,71,0.2);
    border-radius: 6px; margin-bottom: 6px;
    font-family: var(--font-mono); font-size: 11px;
    cursor: pointer; transition: background 0.15s;
  }
  .event-item:hover { background: rgba(255,71,71,0.14); }
  .event-range { color: var(--text); }
  .event-dur   { color: var(--muted); }

  /* ── Export panel ── */
  .export-panel {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 14px;
  }
  .export-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .export-title {
    font-size: 11px;
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
  }
  .export-body { padding: 14px 16px; display: flex; flex-direction: column; gap: 12px; }

  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  .toggle-label { font-size: 12px; color: var(--text); font-family: var(--font-mono); }
  .toggle-sub   { font-size: 10px; color: var(--muted); font-family: var(--font-mono); }

  /* Custom toggle switch */
  .toggle {
    position: relative;
    width: 36px;
    height: 20px;
    flex-shrink: 0;
  }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--border);
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .toggle-slider:before {
    content: "";
    position: absolute;
    width: 14px; height: 14px;
    left: 3px; top: 3px;
    background: var(--muted);
    border-radius: 50%;
    transition: transform 0.2s, background 0.2s;
  }
  .toggle input:checked + .toggle-slider { background: rgba(71,255,160,0.25); }
  .toggle input:checked + .toggle-slider:before { transform: translateX(16px); background: var(--accent4); }

  /* Export progress bar */
  .export-progress-wrap { display: none; flex-direction: column; gap: 5px; }
  .export-progress-wrap.active { display: flex; }
  .export-progress-row { display: flex; justify-content: space-between; font-family: var(--font-mono); font-size: 10px; color: var(--muted); }
  .export-progress-track { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .export-progress-fill {
    height: 100%;
    background: var(--accent4);
    border-radius: 2px;
    width: 0%;
    transition: width 0.3s ease;
  }
  @keyframes indeterminate {
    0%   { left: -40%; width: 40%; }
    100% { left: 100%; width: 40%; }
  }
  .export-progress-fill.indeterminate {
    position: relative;
    width: 40% !important;
    animation: indeterminate 1.2s ease-in-out infinite;
  }

  /* Download button (appears after export) */
  .download-ready {
    display: none;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: rgba(71,255,160,0.07);
    border: 1px solid rgba(71,255,160,0.3);
    border-radius: 8px;
    font-size: 12px;
    font-family: var(--font-mono);
    color: var(--accent4);
  }
  .download-ready.visible { display: flex; }
  .download-ready a {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: rgba(71,255,160,0.15);
    border: 1px solid var(--accent4);
    border-radius: 6px;
    color: var(--accent4);
    font-family: var(--font-display);
    font-size: 11px;
    font-weight: 700;
    text-decoration: none;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
  }
  .download-ready a:hover { background: rgba(71,255,160,0.28); }

  /* ── Loading Overlay ── */
  .loading-overlay {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(10,10,15,0.85);
    backdrop-filter: blur(4px);
    z-index: 50;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    border-radius: 12px;
  }
  .loading-overlay.active { display: flex; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-family: var(--font-mono); font-size: 12px; color: var(--muted); letter-spacing: 0.5px; }

  /* ── Window chart ── */
  .windows-chart   { padding: 14px 16px; border-top: 1px solid var(--border); }
  .chart-title     { font-size: 10px; font-family: var(--font-mono); color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
  .chart-track     { height: 28px; background: var(--surface2); border-radius: 5px; overflow: hidden; display: flex; }
  .chart-seg       { height: 100%; transition: background 0.3s; }

  /* ── Toast ── */
  .toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 18px;
    font-size: 13px; font-family: var(--font-mono);
    color: var(--text); z-index: 999;
    transform: translateY(80px); opacity: 0;
    transition: all 0.25s cubic-bezier(0.16,1,0.3,1);
  }
  .toast.show    { transform: translateY(0); opacity: 1; }
  .toast.error   { border-color: var(--accent2); color: var(--accent2); }
  .toast.success { border-color: var(--accent); color: var(--accent); }

  input[type=range] {
    -webkit-appearance: none; width: 80px; height: 4px;
    background: var(--border); border-radius: 2px; outline: none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px; height: 14px;
    background: var(--accent); border-radius: 50%; cursor: pointer;
  }

  /* ── Upload progress ── */
  .upload-bar-wrap { display: none; flex-direction: column; gap: 5px; margin-top: 10px; }
  .upload-bar-wrap.active { display: flex; }
  .upload-bar-row  { display: flex; justify-content: space-between; font-family: var(--font-mono); font-size: 10px; color: var(--muted); }
  .upload-bar-track { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .upload-bar-fill  { height: 100%; background: var(--accent3); border-radius: 2px; width: 0%; transition: width 0.15s linear; }

  /* ── Session banner ── */
  .session-banner {
    display: none; align-items: center; gap: 10px;
    padding: 10px 14px; background: rgba(255,71,71,0.08);
    border: 1px solid rgba(255,71,71,0.3); border-radius: 8px;
    font-size: 12px; color: var(--accent2); font-family: var(--font-mono); margin-bottom: 0;
  }
  .session-banner.active { display: flex; }
  .session-banner .reconnect-btn {
    margin-left: auto; padding: 4px 10px;
    background: rgba(255,71,71,0.15); border: 1px solid var(--accent2);
    border-radius: 5px; color: var(--accent2); font-family: var(--font-display);
    font-size: 11px; font-weight: 700; cursor: pointer; transition: background 0.15s; white-space: nowrap;
  }
  .session-banner .reconnect-btn:hover { background: rgba(255,71,71,0.28); }
</style>
</head>
<body>

<header>
  <div class="logo">ZA<span>PP</span></div>
  <div class="status-pill">
    <div class="status-dot" id="statusDot"></div>
    <span id="statusText">connecting…</span>
  </div>
</header>

<div class="app">

  <!-- ── Left: Video ── -->
  <div class="video-panel">
    <div class="drop-zone" id="dropZone">
      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Running inference…</div>
      </div>
      <div id="dropContent">
        <div class="drop-icon">▶</div>
        <div class="drop-label">Drop video or click to load</div>
        <div class="drop-sub">MP4 · MOV · AVI · MKV</div>
      </div>
      <video id="player" controls></video>
      <input type="file" id="fileInput" accept="video/*" style="display:none"/>
    </div>

    <div class="timeline-wrap">
      <div class="timeline-header">
        <span class="timeline-title">Timeline</span>
        <span class="timeline-time" id="timeDisplay">00:00.000 / 00:00.000</span>
      </div>
      <div class="timeline-track" id="timelineTrack">
        <div class="timeline-progress" id="tlProgress"></div>
        <div class="timeline-selection" id="tlSelection"></div>
        <div class="timeline-events-overlay" id="tlEventsOverlay"></div>
        <div class="timeline-playhead" id="tlPlayhead"></div>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="btnPlayPause" disabled>⏵ Play</button>
      <input type="range" id="speedRange" min="0.25" max="2" step="0.25" value="1" title="Playback speed">
      <span style="font-size:11px;font-family:var(--font-mono);color:var(--muted)" id="speedLabel">1×</span>
      <div class="spacer"></div>
      <button class="btn" id="btnClearSel" disabled>✕ Clear Selection</button>
    </div>
  </div>

  <!-- ── Right Panel ── -->
  <div class="right-panel">

    <!-- Segment -->
    <div class="panel-section">
      <div class="section-label">Segment Selection</div>

      <div class="segment-row">
        <div class="time-field">
          <label>Start</label>
          <div class="time-input-wrap">
            <input type="number" id="startInput" min="0" step="0.001" placeholder="0.000"/>
            <span class="unit">s</span>
          </div>
        </div>
        <div class="time-field">
          <label>End</label>
          <div class="time-input-wrap">
            <input type="number" id="endInput" min="0" step="0.001" placeholder="0.000"/>
            <span class="unit">s</span>
          </div>
        </div>
      </div>

      <div class="set-btn-row">
        <button class="set-btn" id="btnSetStart">⬅ Set Start from Frame</button>
        <button class="set-btn" id="btnSetEnd">Set End from Frame ➡</button>
      </div>

      <div class="duration-bar">
        <span>Duration</span>
        <span class="duration-val" id="durationVal">—</span>
      </div>

      <div class="session-banner" id="sessionBanner">
        ⚠ Session lost
        <button class="reconnect-btn" id="btnReconnect">↺ Reconnect</button>
      </div>
      <button class="btn primary" id="btnInfer" style="width:100%" disabled>
        ⚡ Run Inference
      </button>
    </div>

    <!-- Options -->
    <div class="panel-section">
      <div class="section-label">Inference Options</div>
      <div class="option-row">
        <div class="time-field">
          <label>Window (s)</label>
          <div class="time-input-wrap">
            <input type="number" id="optWindow" min="0.1" step="0.1" value="1.0"/>
            <span class="unit">s</span>
          </div>
        </div>
        <div class="time-field">
          <label>Stride (s)</label>
          <div class="time-input-wrap">
            <input type="number" id="optStride" min="0.05" step="0.05" value="0.5"/>
            <span class="unit">s</span>
          </div>
        </div>
      </div>
      <div class="time-field">
        <label>API Endpoint</label>
        <div class="time-input-wrap">
          <input type="text" id="apiEndpoint" value="http://localhost:8000" style="font-size:11px"/>
        </div>
      </div>
      <div class="upload-bar-wrap" id="uploadBarWrap">
        <div class="upload-bar-row">
          <span id="uploadLabel">Uploading…</span>
          <span id="uploadPct">0%</span>
        </div>
        <div class="upload-bar-track">
          <div class="upload-bar-fill" id="uploadBarFill"></div>
        </div>
        <div class="upload-bar-row" style="margin-top:2px">
          <span id="uploadSpeed"></span>
          <span id="uploadETA"></span>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="panel-section">
      <div class="section-label">Results</div>
      <div class="result-box" id="resultBox">
        <div class="result-header">
          <div class="result-verdict" id="resultVerdict">—</div>
          <div class="result-confidence" id="resultConf">—</div>
        </div>
        <div class="prob-bars">
          <div class="prob-row">
            <div class="prob-label-row"><span>ZAPPING</span><span id="pZapping">—</span></div>
            <div class="prob-track"><div class="prob-fill zapping" id="barZapping" style="width:0%"></div></div>
          </div>
          <div class="prob-row">
            <div class="prob-label-row"><span>NON-ZAPPING</span><span id="pNonZapping">—</span></div>
            <div class="prob-track"><div class="prob-fill non_zapping" id="barNonZapping" style="width:0%"></div></div>
          </div>
        </div>

        <div class="windows-chart" id="windowsChart" style="display:none">
          <div class="chart-title">Window-by-window probability</div>
          <div class="chart-track" id="chartTrack"></div>
        </div>

        <div class="events-list" id="eventsList" style="display:none">
          <div class="events-title">Detected Events (click to seek)</div>
          <div id="eventsContainer"></div>
        </div>
      </div>

      <!-- ── Export Panel ── -->
      <div class="export-panel" id="exportPanel" style="display:none">
        <div class="export-header">
          <span class="export-title">Export Annotated Segment</span>
        </div>
        <div class="export-body">

          <div class="toggle-row">
            <div>
              <div class="toggle-label">Per-window labels</div>
              <div class="toggle-sub">Burn label + probability on each frame</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="togglePerWindow" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="toggle-row">
            <div>
              <div class="toggle-label">Segment verdict overlay</div>
              <div class="toggle-sub">Show overall result in corner</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="toggleOverall" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="export-progress-wrap" id="exportProgressWrap">
            <div class="export-progress-row">
              <span id="exportProgressLabel">Rendering…</span>
              <span id="exportProgressPct"></span>
            </div>
            <div class="export-progress-track">
              <div class="export-progress-fill indeterminate" id="exportProgressFill"></div>
            </div>
          </div>

          <div class="download-ready" id="downloadReady">
            ✓ Annotated video ready
            <a id="downloadLink" href="#" download>⬇ Download MP4</a>
          </div>

          <button class="btn export" id="btnExport" style="width:100%">
            ⬇ Export Annotated Video
          </button>
        </div>
      </div>

    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ─── State ────────────────────────────────────────────────────────────────────
let videoFile   = null;
let sessionId   = null;
let duration    = 0;
let startSec    = null;
let endSec      = null;
let isDragging  = false;
let lastResult  = null;   // stores most recent /infer response
let exportBlobUrl = null; // current object URL for download

const API = () => document.getElementById('apiEndpoint').value.replace(/\/$/, '');

// ─── DOM refs ─────────────────────────────────────────────────────────────────
const dropZone       = document.getElementById('dropZone');
const dropContent    = document.getElementById('dropContent');
const player         = document.getElementById('player');
const fileInput      = document.getElementById('fileInput');
const tlTrack        = document.getElementById('timelineTrack');
const tlProgress     = document.getElementById('tlProgress');
const tlPlayhead     = document.getElementById('tlPlayhead');
const tlSelection    = document.getElementById('tlSelection');
const tlEventsOverlay = document.getElementById('tlEventsOverlay');
const timeDisplay    = document.getElementById('timeDisplay');
const startInput     = document.getElementById('startInput');
const endInput       = document.getElementById('endInput');
const durationVal    = document.getElementById('durationVal');
const btnSetStart    = document.getElementById('btnSetStart');
const btnSetEnd      = document.getElementById('btnSetEnd');
const btnInfer       = document.getElementById('btnInfer');
const btnPlayPause   = document.getElementById('btnPlayPause');
const btnClearSel    = document.getElementById('btnClearSel');
const speedRange     = document.getElementById('speedRange');
const speedLabel     = document.getElementById('speedLabel');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText    = document.getElementById('loadingText');
const resultBox      = document.getElementById('resultBox');
const exportPanel    = document.getElementById('exportPanel');
const btnExport      = document.getElementById('btnExport');
const downloadReady  = document.getElementById('downloadReady');
const downloadLink   = document.getElementById('downloadLink');
const exportProgressWrap = document.getElementById('exportProgressWrap');
const exportProgressFill = document.getElementById('exportProgressFill');
const exportProgressLabel = document.getElementById('exportProgressLabel');

// ─── Health check ─────────────────────────────────────────────────────────────
async function checkHealth() {
  try {
    const res = await fetch(`${API()}/health`, { signal: AbortSignal.timeout(3000) });
    const data = await res.json();
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    if (data.model_loaded) {
      dot.className = 'status-dot ok';
      txt.textContent = `model ready · ${data.device}`;
    } else {
      dot.className = 'status-dot err';
      txt.textContent = 'model not loaded';
    }
  } catch {
    document.getElementById('statusDot').className = 'status-dot err';
    document.getElementById('statusText').textContent = 'api unreachable';
  }
}
checkHealth();
setInterval(checkHealth, 10000);

// ─── File loading ─────────────────────────────────────────────────────────────
dropZone.addEventListener('click', e => { if (e.target === player) return; fileInput.click(); });
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragging'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragging'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragging');
  const f = e.dataTransfer.files[0];
  if (f) loadVideo(f);
});
fileInput.addEventListener('change', () => { if (fileInput.files[0]) loadVideo(fileInput.files[0]); });

function loadVideo(file) {
  if (sessionId) {
    fetch(`${API()}/session/${sessionId}`, { method: 'DELETE' }).catch(() => {});
    sessionId = null;
  }
  videoFile = file;
  const url = URL.createObjectURL(file);
  player.src = url;
  player.style.display = 'block';
  dropContent.style.display = 'none';
  dropZone.classList.add('has-video');
  btnPlayPause.disabled = false;
  resetExportUI();
  uploadVideo(file);
}

function uploadVideo(file) {
  document.getElementById('statusDot').className = 'status-dot';
  document.getElementById('statusText').textContent = 'uploading…';
  hideBanner();

  const wrap = document.getElementById('uploadBarWrap');
  const fill = document.getElementById('uploadBarFill');
  const pct  = document.getElementById('uploadPct');
  const lbl  = document.getElementById('uploadLabel');
  const spd  = document.getElementById('uploadSpeed');
  const eta  = document.getElementById('uploadETA');

  wrap.classList.add('active');
  fill.style.width = '0%';
  pct.textContent = '0%';
  lbl.textContent = `Uploading ${file.name}`;
  spd.textContent = '';
  eta.textContent = '';

  const startTime = Date.now();
  const formData = new FormData();
  formData.append('video', file);

  const xhr = new XMLHttpRequest();
  xhr.open('POST', `${API()}/upload`);

  xhr.upload.addEventListener('progress', e => {
    if (!e.lengthComputable) return;
    const pctVal = (e.loaded / e.total) * 100;
    fill.style.width = pctVal.toFixed(1) + '%';
    pct.textContent = pctVal.toFixed(0) + '%';
    const elapsed = (Date.now() - startTime) / 1000;
    if (elapsed > 0.5) {
      const bps = e.loaded / elapsed;
      const rem = (e.total - e.loaded) / bps;
      spd.textContent = formatBytes(bps) + '/s';
      eta.textContent = rem > 1 ? `~${Math.ceil(rem)}s left` : 'almost done…';
    }
  });

  xhr.addEventListener('load', () => {
    wrap.classList.remove('active');
    if (xhr.status >= 200 && xhr.status < 300) {
      const data = JSON.parse(xhr.responseText);
      sessionId = data.session_id;
      toast(`Ready: ${file.name} · ${data.duration.toFixed(1)}s`, 'success');
    } else {
      let msg = xhr.statusText;
      try { msg = JSON.parse(xhr.responseText).detail || msg; } catch {}
      toast('Upload failed: ' + msg, 'error');
    }
    checkHealth();
  });

  xhr.addEventListener('error', () => {
    wrap.classList.remove('active');
    toast('Upload failed: network error', 'error');
    checkHealth();
  });

  xhr.send(formData);
}

player.addEventListener('loadedmetadata', () => {
  duration = player.duration;
  updateTimeDisplay();
});

// ─── Playback ─────────────────────────────────────────────────────────────────
player.addEventListener('timeupdate', updateTimeline);
btnPlayPause.addEventListener('click', () => {
  if (player.paused) { player.play(); btnPlayPause.textContent = '⏸ Pause'; }
  else { player.pause(); btnPlayPause.textContent = '⏵ Play'; }
});
player.addEventListener('ended', () => { btnPlayPause.textContent = '⏵ Play'; });

speedRange.addEventListener('input', () => {
  player.playbackRate = parseFloat(speedRange.value);
  speedLabel.textContent = speedRange.value + '×';
});

// ─── Timeline ─────────────────────────────────────────────────────────────────
function updateTimeline() {
  if (!duration) return;
  const pct = player.currentTime / duration;
  tlProgress.style.width = (pct * 100) + '%';
  tlPlayhead.style.left  = (pct * 100) + '%';
  updateTimeDisplay();
}
function updateTimeDisplay() {
  timeDisplay.textContent = `${fmtTime(player.currentTime)} / ${fmtTime(duration)}`;
}

tlTrack.addEventListener('mousedown', e => { if (!duration) return; isDragging = true; seekFromEvent(e); });
document.addEventListener('mousemove', e => { if (!isDragging) return; seekFromEvent(e); });
document.addEventListener('mouseup', () => { isDragging = false; });

function seekFromEvent(e) {
  const rect = tlTrack.getBoundingClientRect();
  const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
  player.currentTime = (x / rect.width) * duration;
}

// ─── Selection ────────────────────────────────────────────────────────────────
btnSetStart.addEventListener('click', () => { startSec = player.currentTime; startInput.value = startSec.toFixed(3); updateSelectionUI(); updateDuration(); });
btnSetEnd.addEventListener('click',   () => { endSec   = player.currentTime; endInput.value   = endSec.toFixed(3);   updateSelectionUI(); updateDuration(); });
startInput.addEventListener('input',  () => { startSec = parseFloat(startInput.value) || null; updateSelectionUI(); updateDuration(); });
endInput.addEventListener('input',    () => { endSec   = parseFloat(endInput.value) || null;   updateSelectionUI(); updateDuration(); });

btnClearSel.addEventListener('click', () => {
  startSec = endSec = null;
  startInput.value = '';
  endInput.value = '';
  tlSelection.style.display = 'none';
  durationVal.textContent = '—';
  btnInfer.disabled = true;
  btnClearSel.disabled = true;
});

function updateSelectionUI() {
  if (startSec !== null && endSec !== null && duration > 0) {
    const l = (Math.min(startSec, endSec) / duration) * 100;
    const w = (Math.abs(endSec - startSec) / duration) * 100;
    tlSelection.style.display = 'block';
    tlSelection.style.left  = l + '%';
    tlSelection.style.width = w + '%';
    btnInfer.disabled   = false;
    btnClearSel.disabled = false;
  }
}

function updateDuration() {
  if (startSec !== null && endSec !== null) {
    durationVal.textContent = Math.abs(endSec - startSec).toFixed(3) + 's';
  }
}

// ─── Inference ────────────────────────────────────────────────────────────────
btnInfer.addEventListener('click', runInference);

async function runInference() {
  if (!videoFile) return toast('No video loaded', 'error');
  if (startSec === null || endSec === null) return toast('Set start and end first', 'error');

  const s = Math.min(startSec, endSec);
  const e = Math.max(startSec, endSec);
  if (e - s < 0.1) return toast('Segment too short', 'error');

  if (!sessionId) { if (videoFile) showBanner(); else toast('No video loaded', 'error'); return; }

  const winSize = parseFloat(document.getElementById('optWindow').value) || 1.0;
  const stride  = parseFloat(document.getElementById('optStride').value) || 0.5;

  loadingOverlay.classList.add('active');
  loadingText.textContent = 'Running inference…';

  try {
    const res = await fetch(`${API()}/infer`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: sessionId, start_time: s, end_time: e, window_size: winSize, stride }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({ detail: res.statusText }));
      if (res.status === 404 || res.status === 410) { sessionId = null; showBanner(); throw new Error('Session expired — please reconnect.'); }
      throw new Error(err.detail || 'Inference failed');
    }

    const data = await res.json();
    lastResult = data;
    displayResults(data);
    renderEventOverlays(data, s, e);
    // Show export panel now that we have results
    exportPanel.style.display = 'block';
    resetExportUI();
    toast('Inference complete', 'success');
  } catch (err) {
    toast('Error: ' + err.message, 'error');
  } finally {
    loadingOverlay.classList.remove('active');
  }
}

function displayResults(data) {
  resultBox.classList.add('visible');

  const verdict = document.getElementById('resultVerdict');
  verdict.textContent = data.prediction === 'zapping' ? '⚡ ZAPPING' : '✓ NON-ZAPPING';
  verdict.className = 'result-verdict ' + data.prediction;

  document.getElementById('resultConf').textContent = `${(data.confidence * 100).toFixed(1)}% confidence`;

  const pz = data.prob_zapping;
  const pn = data.prob_non_zapping;
  document.getElementById('pZapping').textContent    = (pz * 100).toFixed(1) + '%';
  document.getElementById('pNonZapping').textContent = (pn * 100).toFixed(1) + '%';

  setTimeout(() => {
    document.getElementById('barZapping').style.width    = (pz * 100) + '%';
    document.getElementById('barNonZapping').style.width = (pn * 100) + '%';
  }, 50);

  if (data.windows && data.windows.length > 0) {
    const chart = document.getElementById('windowsChart');
    const track = document.getElementById('chartTrack');
    chart.style.display = 'block';
    track.innerHTML = '';
    const segDur = data.segment.duration;
    data.windows.forEach(w => {
      const seg = document.createElement('div');
      seg.className = 'chart-seg';
      const wDur = w.end_time - w.start_time;
      seg.style.width = ((wDur / segDur) * 100) + '%';
      seg.style.background = `rgba(${Math.round(255*w.prob_zapping)}, ${Math.round(255*(1-w.prob_zapping)*0.6 + 50)}, 71, 0.8)`;
      seg.title = `${fmtTime(w.start_time)}–${fmtTime(w.end_time)}: ${(w.prob_zapping*100).toFixed(1)}% zapping`;
      track.appendChild(seg);
    });
  }

  if (data.zapping_events && data.zapping_events.length > 0) {
    const evList = document.getElementById('eventsList');
    const evContainer = document.getElementById('eventsContainer');
    evList.style.display = 'block';
    evContainer.innerHTML = '';
    data.zapping_events.forEach(ev => {
      const item = document.createElement('div');
      item.className = 'event-item';
      item.innerHTML = `<span class="event-range">${fmtTime(ev.start)} → ${fmtTime(ev.end)}</span><span class="event-dur">${ev.duration}s</span>`;
      item.addEventListener('click', () => { player.currentTime = ev.start; player.play(); btnPlayPause.textContent = '⏸ Pause'; });
      evContainer.appendChild(item);
    });
  } else {
    document.getElementById('eventsList').style.display = 'none';
  }
}

function renderEventOverlays(data, segStart, segEnd) {
  tlEventsOverlay.innerHTML = '';
  if (!data.zapping_events || !duration) return;
  data.zapping_events.forEach(ev => {
    const div = document.createElement('div');
    const l = (ev.start / duration) * 100;
    const w = ((ev.end - ev.start) / duration) * 100;
    div.style.cssText = `position:absolute;top:0;bottom:0;left:${l}%;width:${w}%;background:rgba(255,71,71,0.25);border-top:2px solid var(--accent2);pointer-events:none;`;
    tlEventsOverlay.appendChild(div);
  });
}

// ─── Export ───────────────────────────────────────────────────────────────────
btnExport.addEventListener('click', runExport);

async function runExport() {
  if (!lastResult || !sessionId) return toast('Run inference first', 'error');

  const burnPerWindow = document.getElementById('togglePerWindow').checked;
  const showOverall   = document.getElementById('toggleOverall').checked;

  // Revoke old blob URL
  if (exportBlobUrl) { URL.revokeObjectURL(exportBlobUrl); exportBlobUrl = null; }

  // UI: show progress
  downloadReady.classList.remove('visible');
  exportProgressWrap.classList.add('active');
  exportProgressFill.classList.add('indeterminate');
  exportProgressLabel.textContent = 'Rendering annotated video…';
  btnExport.disabled = true;
  btnExport.classList.add('loading');

  try {
    const body = {
      session_id: sessionId,
      start_time: lastResult.segment.start,
      end_time:   lastResult.segment.end,
      windows:    lastResult.windows,
      burn_per_window: burnPerWindow,
      overall_prediction: showOverall ? lastResult.prediction   : null,
      overall_confidence: showOverall ? lastResult.confidence   : null,
    };

    const res = await fetch(`${API()}/export`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({ detail: res.statusText }));
      if (res.status === 404 || res.status === 410) { sessionId = null; showBanner(); throw new Error('Session expired.'); }
      throw new Error(err.detail || 'Export failed');
    }

    const blob = await res.blob();
    exportBlobUrl = URL.createObjectURL(blob);

    const s = lastResult.segment.start;
    const e = lastResult.segment.end;
    const fname = `annotated_${s.toFixed(2)}-${e.toFixed(2)}.mp4`;
    downloadLink.href     = exportBlobUrl;
    downloadLink.download = fname;
    downloadLink.textContent = `⬇ Download ${fname}`;

    downloadReady.classList.add('visible');
    toast('Export ready — click to download', 'success');
  } catch (err) {
    toast('Export error: ' + err.message, 'error');
  } finally {
    exportProgressWrap.classList.remove('active');
    exportProgressFill.classList.remove('indeterminate');
    btnExport.disabled = false;
    btnExport.classList.remove('loading');
  }
}

function resetExportUI() {
  exportProgressWrap.classList.remove('active');
  downloadReady.classList.remove('visible');
  btnExport.disabled = false;
  btnExport.classList.remove('loading');
  if (exportBlobUrl) { URL.revokeObjectURL(exportBlobUrl); exportBlobUrl = null; }
}

// ─── Session banner ───────────────────────────────────────────────────────────
function showBanner() { document.getElementById('sessionBanner').classList.add('active'); }
function hideBanner()  { document.getElementById('sessionBanner').classList.remove('active'); }

document.getElementById('btnReconnect').addEventListener('click', () => {
  if (!videoFile) return toast('No video file in memory — please reload the page.', 'error');
  hideBanner();
  sessionId = null;
  uploadVideo(videoFile);
});

// ─── Utilities ────────────────────────────────────────────────────────────────
function formatBytes(bytes) {
  if (bytes >= 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  if (bytes >= 1024) return (bytes / 1024).toFixed(0) + ' KB';
  return bytes.toFixed(0) + ' B';
}

function fmtTime(s) {
  if (!isFinite(s)) return '00:00.000';
  const m = Math.floor(s / 60);
  const sec = (s % 60).toFixed(3).padStart(6, '0');
  return `${String(m).padStart(2,'0')}:${sec}`;
}

let toastTimer;
function toast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = 'toast'; }, 3500);
}
</script>
</body>
</html>